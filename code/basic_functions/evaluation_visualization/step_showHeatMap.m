function step_showHeatMap
showPercent=0.3;
shownonactivated=true;

%showHeatMap('horse','horse',1,showPercent,shownonactivated);

folder='../../../../../home/vcla/zqs/QAinDeep_vclagpu/code/mat/';
partID=1;
cateName='horse';showHeatMap([folder,cateName,'/Para_3.5'],cateName,partID,showPercent,shownonactivated);

% folder='../../../../../home/vcla/zqs/QAinDeep_vclagpu/code/mat/';
% partID=1;
% cateName='bird';showHeatMap([folder,cateName,'/Exp_init'],cateName,partID,showPercent,shownonactivated);
% cateName='cat';showHeatMap([folder,cateName,'/Exp_init'],cateName,partID,showPercent,shownonactivated);
% cateName='cow';showHeatMap([folder,cateName,'/Exp_init'],cateName,partID,showPercent,shownonactivated);
% cateName='dog';showHeatMap([folder,cateName,'/Exp_init'],cateName,partID,showPercent,shownonactivated);
% cateName='horse';showHeatMap([folder,cateName,'/Exp_init'],cateName,partID,showPercent,shownonactivated);
% cateName='sheep';showHeatMap([folder,cateName,'/Exp_init'],cateName,partID,showPercent,shownonactivated);

% cateName='n01443537';showHeatMap([folder,cateName,'/Exp_init'],cateName,partID,showPercent,shownonactivated);
% cateName='n01503061';showHeatMap([folder,cateName,'/Exp_init'],cateName,partID,showPercent,shownonactivated);
% cateName='n01639765';showHeatMap([folder,cateName,'/Exp_init'],cateName,partID,showPercent,shownonactivated);
% cateName='n01662784';showHeatMap([folder,cateName,'/Exp_init'],cateName,partID,showPercent,shownonactivated);
% cateName='n01674464';showHeatMap([folder,cateName,'/Exp_init'],cateName,partID,showPercent,shownonactivated);
% cateName='n01882714';showHeatMap([folder,cateName,'/Exp_init'],cateName,partID,showPercent,shownonactivated);
% cateName='n01982650';showHeatMap([folder,cateName,'/Exp_init'],cateName,partID,showPercent,shownonactivated);
% cateName='n02084071';showHeatMap([folder,cateName,'/Exp_init'],cateName,partID,showPercent,shownonactivated);
% cateName='n02118333';showHeatMap([folder,cateName,'/Exp_init'],cateName,partID,showPercent,shownonactivated);
% cateName='n02121808';showHeatMap([folder,cateName,'/Exp_init'],cateName,partID,showPercent,shownonactivated);
% cateName='n02129165';showHeatMap([folder,cateName,'/Exp_init'],cateName,partID,showPercent,shownonactivated);
% cateName='n02129604';showHeatMap([folder,cateName,'/Exp_init'],cateName,partID,showPercent,shownonactivated);
% cateName='n02131653';showHeatMap([folder,cateName,'/Exp_init'],cateName,partID,showPercent,shownonactivated);
% cateName='n02324045';showHeatMap([folder,cateName,'/Exp_init'],cateName,partID,showPercent,shownonactivated);
% cateName='n02342885';showHeatMap([folder,cateName,'/Exp_init'],cateName,partID,showPercent,shownonactivated);
% cateName='n02355227';showHeatMap([folder,cateName,'/Exp_init'],cateName,partID,showPercent,shownonactivated);
% cateName='n02374451';showHeatMap([folder,cateName,'/Exp_init'],cateName,partID,showPercent,shownonactivated);
% cateName='n02391049';showHeatMap([folder,cateName,'/Exp_init'],cateName,partID,showPercent,shownonactivated);
% cateName='n02395003';showHeatMap([folder,cateName,'/Exp_init'],cateName,partID,showPercent,shownonactivated);
% cateName='n02398521';showHeatMap([folder,cateName,'/Exp_init'],cateName,partID,showPercent,shownonactivated);
% cateName='n02402425';showHeatMap([folder,cateName,'/Exp_init'],cateName,partID,showPercent,shownonactivated);
% cateName='n02411705';showHeatMap([folder,cateName,'/Exp_init'],cateName,partID,showPercent,shownonactivated);
% cateName='n02419796';showHeatMap([folder,cateName,'/Exp_init'],cateName,partID,showPercent,shownonactivated);
% cateName='n02437136';showHeatMap([folder,cateName,'/Exp_init'],cateName,partID,showPercent,shownonactivated);
% cateName='n02444819';showHeatMap([folder,cateName,'/Exp_init'],cateName,partID,showPercent,shownonactivated);
% cateName='n02454379';showHeatMap([folder,cateName,'/Exp_init'],cateName,partID,showPercent,shownonactivated);
% cateName='n02484322';showHeatMap([folder,cateName,'/Exp_init'],cateName,partID,showPercent,shownonactivated);
% cateName='n02503517';showHeatMap([folder,cateName,'/Exp_init'],cateName,partID,showPercent,shownonactivated);
% cateName='n02509815';showHeatMap([folder,cateName,'/Exp_init'],cateName,partID,showPercent,shownonactivated);
% cateName='n02510455';showHeatMap([folder,cateName,'/Exp_init'],cateName,partID,showPercent,shownonactivated);
return



%showHeatMap('n02374451','n02374451',1,showPercent,shownonactivated);
%return


% showHeatMap('Exp2/n01443537/sampleNum_04','n01443537',1,showPercent,shownonactivated);
% showHeatMap('Exp2/n01503061/sampleNum_04','n01503061',1,showPercent,shownonactivated);
% showHeatMap('Exp2/n01639765/sampleNum_04','n01639765',1,showPercent,shownonactivated);
% showHeatMap('Exp2/n01662784/sampleNum_04','n01662784',1,showPercent,shownonactivated);
% showHeatMap('Exp2/n01674464/sampleNum_04','n01674464',1,showPercent,shownonactivated);
% showHeatMap('Exp2/n01882714/sampleNum_04','n01882714',1,showPercent,shownonactivated);
% showHeatMap('Exp2/n01982650/sampleNum_04','n01982650',1,showPercent,shownonactivated);
% showHeatMap('Exp2/n02084071/sampleNum_04','n02084071',1,showPercent,shownonactivated);
% showHeatMap('Exp2/n02118333/sampleNum_04','n02118333',1,showPercent,shownonactivated);
% showHeatMap('Exp2/n02121808/sampleNum_04','n02121808',1,showPercent,shownonactivated);
% showHeatMap('Exp2/n02129165/sampleNum_04','n02129165',1,showPercent,shownonactivated);
% showHeatMap('Exp2/n02129604/sampleNum_04','n02129604',1,showPercent,shownonactivated);
% showHeatMap('Exp2/n02131653/sampleNum_04','n02131653',1,showPercent,shownonactivated);
% showHeatMap('Exp2/n02324045/sampleNum_04','n02324045',1,showPercent,shownonactivated);
% showHeatMap('Exp2/n02342885/sampleNum_04','n02342885',1,showPercent,shownonactivated);
% showHeatMap('Exp2/n02355227/sampleNum_04','n02355227',1,showPercent,shownonactivated);
% showHeatMap('Exp2/n02374451/sampleNum_04','n02374451',1,showPercent,shownonactivated);
% showHeatMap('Exp2/n02391049/sampleNum_04','n02391049',1,showPercent,shownonactivated);
% showHeatMap('Exp2/n02395003/sampleNum_04','n02395003',1,showPercent,shownonactivated);
% showHeatMap('Exp2/n02398521/sampleNum_04','n02398521',1,showPercent,shownonactivated);
% showHeatMap('Exp2/n02402425/sampleNum_04','n02402425',1,showPercent,shownonactivated);
% showHeatMap('Exp2/n02411705/sampleNum_04','n02411705',1,showPercent,shownonactivated);
% showHeatMap('Exp2/n02419796/sampleNum_04','n02419796',1,showPercent,shownonactivated);
% showHeatMap('Exp2/n02437136/sampleNum_04','n02437136',1,showPercent,shownonactivated);
% showHeatMap('Exp2/n02444819/sampleNum_04','n02444819',1,showPercent,shownonactivated);
% showHeatMap('Exp2/n02454379/sampleNum_04','n02454379',1,showPercent,shownonactivated);
% showHeatMap('Exp2/n02484322/sampleNum_04','n02484322',1,showPercent,shownonactivated);
% showHeatMap('Exp2/n02503517/sampleNum_04','n02503517',1,showPercent,shownonactivated);
% showHeatMap('Exp2/n02509815/sampleNum_04','n02509815',1,showPercent,shownonactivated);
% showHeatMap('Exp2/n02510455/sampleNum_04','n02510455',1,showPercent,shownonactivated);
end


function showHeatMap(Name_batch_model,Name_batch,partID,showPercent,shownonactivated)
global conf;
theConf=conf;
thePara=@getLossPara_normal;
stepNum=1;
while(true)
    cateLabel_name=sprintf('%s%s/part%02d_step%02d.mat',theConf.output.dir,Name_batch_model,partID,stepNum+1);
    if(exist(cateLabel_name,'file')==2)
        stepNum=stepNum+1;
    else
        break;
    end
end

stepNum=3


cateLabel_name=sprintf('%s%s/part%02d_step%02d.mat',theConf.output.dir,Name_batch_model,partID,stepNum);
load(cateLabel_name,'parts','parts_corner','label_set');

if(length(label_set)<stepNum)
    clear label_set;
    cateLabel_name=sprintf('%s%s/part%02d_label.mat',theConf.output.dir,Name_batch_model,partID);
    load(cateLabel_name,'label_set');
end

% l=label_set;
% cateLabel_name=sprintf('%s%s/part%02d_step%02d.mat',theConf.output.dir,Name_batch,partID,stepNum);
% %%%Name_batch_tmp='horse/Exp1';cateLabel_name=sprintf('%s%s/part%02d_step%02d.mat',theConf.output.dir,Name_batch_tmp,partID,stepNum);
% load(cateLabel_name,'parts','parts_corner','label_set');
% label_set=l;

%label_set=label_set(9);

% cateLabel_name=sprintf('%s%s/part%02d_label.mat',theConf.output.dir,Name_batch_model,partID);
% load(cateLabel_name,'label_set');
% label_set=label_set(1:3:12);



% theLabel=label_set(1);
% tmp=readAnnotation(Name_batch,conf);
% theLabel.obj=tmp(36);
% theLabel.pHW_center=[];
% theLabel.pHW_scale=[];
% theLabel.poseID=1;
% theLabel.flip=true;




parts=uncompressAOG(parts);
% parts=uncompressAOG(parts_corner(1));



layerNum=length(theConf.convnet.targetLayers);
file_genLoss=[theConf.output.dir,Name_batch,'/genLoss.mat'];
if(~exist(file_genLoss,'file'))
    step_getAvgResponse(Name_batch);
end
load(file_genLoss,'Loss');
load([theConf.output.dir,Name_batch,'/net_finetune.mat'],'net','info');
load([theConf.output.dir,Name_batch,'/all_statistics.mat'],'stat_all');
theStat_all=stat_all;clear stat_all;
c=0;
for label=label_set
    c=c+1;
    [res,I_patch,~]=getObjFeature(label.obj,theConf,net,label.flip);
    mapSize=[size(I_patch,1),size(I_patch,2)];
    parent_record=[];
    xHWList=[];
    layerList=[];
    best_record=repmat(struct('depth',[]),[1,layerNum]);
    poseID=label.poseID;
    pHW_avg=get_pHW_avg(label_set,poseID);
    [parts_pose,gen]=getPartsAndLoss_withoutInvalid(Loss,parts(poseID));
    for layer=layerNum:-1:1
        v=f_norm(res,layer,theConf,theStat_all);
        depthNum=length(parts_pose.layer(layer).depth);
        fset=label.app(layer).HOG;
        
        best_record(layer).depth=getGenDisL_layerBatch(v.x,v.valid,gen(layer).depth,layer,parts_pose.layer(layer).depth,fset,pHW_avg,parent_record,theConf,label.pHW_center,thePara);
        
        for d=1:depthNum
            if(~isempty(best_record(layer).depth(d).best))
                best=best_record(layer).depth(d).best;
                if(shownonactivated)
                    detected_xHW=best.xHW;
                else
                    detected_xHW=best.xHW(:,best.local>0);
                end
                detectedNum=size(detected_xHW,2);
                if(detectedNum>0)
                    if(isempty(layerList))
                        xHWList=detected_xHW;
                        layerList=repmat(layer,[1,detectedNum]);
                    else
                        xHWList(:,end+1:end+detectedNum)=detected_xHW;
                        layerList(end+1:end+detectedNum)=layer;
                    end
                end
            end
        end
        parent_record=getParentLayerRecord(best_record(layer).depth,parts_pose.layer(layer).depth,layer,theConf);
    end
    thePara=@getLossPara_normal;
    fileroot=sprintf('./fig_out/fig/%s_ant%02d_',Name_batch,c);
%     [map,~]=produceMap(best_record,theConf,pHW_avg,mapSize,thePara);
%     showFilter(xHWList,layerList,I_patch,showPercent);pause(0.2);
%     saveas(gcf,[fileroot,'cicle.fig']);
%     close gcf;
%     saveas(gcf,[fileroot,'cicle_2.fig']);
%     close gcf;
%     figure;imagesc(map.map);pause(0.2);
%     saveas(gcf,[fileroot,'localization.fig']);
%     close gcf;
    heatMap=getHeatMap(xHWList,layerList,mapSize,theConf);
    figure;imshow(uint8(I_patch));hold on;pause(0.2);
%     tar_h=label.pHW_center(1);
%     tar_w=label.pHW_center(2);
%     scale_h=label.pHW_scale(1);
%     scale_w=label.pHW_scale(2);
%     plot(tar_w+[0.5,0.5,-0.5,-0.5,0.5].*scale_w,tar_h+[0.5,-0.5,-0.5,0.5,0.5].*scale_h,'w-','LineWidth',2);
%     pause(0.2);
    saveas(gcf,[fileroot,'ant.jpg']);
    close gcf;
    tmpMap=heatMap(1).map./sqrt(var(heatMap(1).map(heatMap(1).map>min(heatMap(1).map(1:end)))));
    tmpMap=tmpMap+heatMap(2).map./sqrt(var(heatMap(2).map(heatMap(2).map>min(heatMap(2).map(1:end)))));
    tmpMap=tmpMap+heatMap(3).map./sqrt(var(heatMap(3).map(heatMap(3).map>min(heatMap(3).map(1:end)))));
    tmpMap=tmpMap+heatMap(4).map./sqrt(var(heatMap(4).map(heatMap(4).map>min(heatMap(4).map(1:end)))));
    tmpMap=tmpMap+heatMap(5).map./sqrt(var(heatMap(5).map(heatMap(5).map>min(heatMap(5).map(1:end)))));
    tmpMap=tmpMap+heatMap(6).map./sqrt(var(heatMap(6).map(heatMap(6).map>min(heatMap(6).map(1:end)))));
    tmpMap=tmpMap+heatMap(7).map./sqrt(var(heatMap(7).map(heatMap(7).map>min(heatMap(7).map(1:end)))));
    tmpMap=tmpMap+heatMap(8).map./sqrt(var(heatMap(8).map(heatMap(8).map>min(heatMap(8).map(1:end)))));
    tmpMap=tmpMap+heatMap(9).map./sqrt(var(heatMap(9).map(heatMap(9).map>min(heatMap(9).map(1:end)))));
    figure;imagesc(tmpMap);pause(0.2);
    saveas(gcf,[fileroot,'heat_123456789.jpg']);
    close gcf;
    figure;imagesc(heatMap(1).map);pause(0.2);
    saveas(gcf,[fileroot,'heat_1.jpg']);
    close gcf;
    figure;imagesc(heatMap(2).map);pause(0.2);
    saveas(gcf,[fileroot,'heat_2.jpg']);
    close gcf;
    figure;imagesc(heatMap(3).map);pause(0.2);
    saveas(gcf,[fileroot,'heat_3.jpg']);
    close gcf;
    figure;imagesc(heatMap(4).map);pause(0.2);
    saveas(gcf,[fileroot,'heat_4.jpg']);
    close gcf;
    figure;imagesc(heatMap(5).map);pause(0.2);
    saveas(gcf,[fileroot,'heat_5.jpg']);
    close gcf;
    figure;imagesc(heatMap(6).map);pause(0.2);
    saveas(gcf,[fileroot,'heat_6.jpg']);
    close gcf;
    figure;imagesc(heatMap(7).map);pause(0.2);
    saveas(gcf,[fileroot,'heat_7.jpg']);
    close gcf;
    figure;imagesc(heatMap(8).map);pause(0.2);
    saveas(gcf,[fileroot,'heat_8.jpg']);
    close gcf;
    figure;imagesc(heatMap(9).map);pause(0.2);
    saveas(gcf,[fileroot,'heat_9.jpg']);
    close gcf;
%     figure;imagesc(heatMap(2).map);pause(0.2);
%     saveas(gcf,[fileroot,'heat_2.fig']);
%     close gcf;
%     figure;imagesc(heatMap(3).map);pause(0.2);
%     saveas(gcf,[fileroot,'heat_3.fig']);
%     close gcf;
%     figure;imagesc(heatMap(6).map);pause(0.2);
%     saveas(gcf,[fileroot,'heat_6.fig']);
%     close gcf;
%     figure;imagesc(heatMap(9).map);pause(0.2);
%     saveas(gcf,[fileroot,'heat_9.fig']);
%     close gcf;
    fprintf('step %d  object ID %d  pose ID %d\n',c,label.obj.ID,poseID);
    %pause;
    close all;
end
disp(Name_batch_model);
end
